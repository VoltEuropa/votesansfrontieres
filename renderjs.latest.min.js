/** 
  * RenderJS by www.nexedi.com
  * 
  * RenderJS is free software licensed under GPLv3+ with additional permission
  * to link, combine and redistribute it with other free or open source software.
  *
  * Please see https://www.nexedi.com/licensing for rationale and options.
  * 
  * https://lab.nexedi.com/nexedi/renderjs/raw/master/dist/renderjs-latest.js
  **/
var Channel=function(){"use strict";var d=Math.floor(1000001*Math.random()),l={};function L(e){return Array.isArray?Array.isArray(e):-1!=e.constructor.toString().indexOf("Array")}var q={},e=function(e){try{var t=JSON.parse(e.data);if("object"!=typeof t||null===t)throw"malformed"}catch(e){return}var r,n,o,i=e.source,a=e.origin;if("string"==typeof t.method){var s=t.method.split("::");2==s.length?(r=s[0],o=s[1]):o=t.method}if(void 0!==t.id&&(n=t.id),"string"==typeof o){var c=!1;if(l[a]&&l[a][r])for(var u=0;u<l[a][r].length;u++)if(l[a][r][u].win===i){l[a][r][u].handler(a,o,t),c=!0;break}if(!c&&l["*"]&&l["*"][r])for(u=0;u<l["*"][r].length;u++)if(l["*"][r][u].win===i){l["*"][r][u].handler(a,o,t);break}}else void 0!==n&&q[n]&&q[n](a,o,t)};return window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent&&window.attachEvent("onmessage",e),{build:function(w){var v=function(e){if(w.debugOutput&&window.console&&window.console.log){try{"string"!=typeof e&&(e=JSON.stringify(e))}catch(e){}console.log("["+r+"] "+e)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if("object"!=typeof w)throw"Channel build invoked without a proper object argument";if(!w.window||!w.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===w.window)throw"target window is same as present window -- not allowed";var e,t=!1;"string"==typeof w.origin&&("*"===w.origin?t=!0:null!==(e=w.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))&&(w.origin=e[0].toLowerCase(),t=!0));if(!t)throw"Channel.build() called with an invalid origin";if(void 0!==w.scope){if("string"!=typeof w.scope)throw"scope, when specified, must be a string";if(1<w.scope.split("::").length)throw"scope may not contain double colons: '::'"}var r=function(){for(var e="",t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r=0;r<5;r++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),y={},b={},E={},n=!1,o=[],c=function(e,t,r){if("function"==typeof w.gotMessageObserver)try{w.gotMessageObserver(e,r)}catch(e){v("gotMessageObserver() raised an exception: "+e.toString())}if(r.id&&t){if(y[t]){var n=(f=r.id,p=e,_=r.callbacks?r.callbacks:[],m=g=!1,{origin:p,invoke:function(e,t){if(!E[f])throw"attempting to invoke a callback of a nonexistent transaction: "+f;for(var r=!1,n=0;n<_.length;n++)if(e===_[n]){r=!0;break}if(!r)throw"request supports no such callback '"+e+"'";S({id:f,callback:e,params:t})},error:function(e,t){if(m=!0,!E[f])throw"error called for nonexistent message: "+f;delete E[f],S({id:f,error:e,message:t})},complete:function(e){if(m=!0,!E[f])throw"complete called for nonexistent message: "+f;delete E[f],S({id:f,result:e})},delayReturn:function(e){return"boolean"==typeof e&&(g=!0===e),g},completed:function(){return m}});E[r.id]={};try{if(r.callbacks&&L(r.callbacks)&&0<r.callbacks.length)for(var o=0;o<r.callbacks.length;o++){for(var i=r.callbacks[o],a=r.params,s=i.split("/"),c=0;c<s.length-1;c++){var u=s[c];"object"!=typeof a[u]&&(a[u]={}),a=a[u]}a[s[s.length-1]]=function(){var t=i;return function(e){return n.invoke(t,e)}}()}var d=y[t](n,r.params);n.delayReturn()||n.completed()||n.complete(d)}catch(t){var l="runtime_error",h=null;if("string"==typeof t?h=t:"object"==typeof t&&(t&&L(t)&&2==t.length?(l=t[0],h=t[1]):"string"==typeof t.error&&(l=t.error,t.message?"string"==typeof t.message?h=t.message:t=t.message:h="")),null===h)try{void 0===(h=JSON.stringify(t))&&(h=t.toString())}catch(e){h=t.toString()}n.error(l,h)}}}else r.id&&r.callback?b[r.id]&&b[r.id].callbacks&&b[r.id].callbacks[r.callback]?b[r.id].callbacks[r.callback](r.params):v("ignoring invalid callback, id:"+r.id+" ("+r.callback+")"):r.id?b[r.id]?(r.error?(0,b[r.id].error)(r.error,r.message):void 0!==r.result?(0,b[r.id].success)(r.result):(0,b[r.id].success)(),delete b[r.id],delete q[r.id]):v("ignoring invalid response: "+r.id):t&&y[t]&&y[t]({origin:e},r.params);var f,p,_,g,m};!function(r,e,t,n){function o(e){for(var t=0;t<e.length;t++)if(e[t].win===r)return!0;return!1}var i=!1;if("*"===e){for(var a in l)if(l.hasOwnProperty(a)&&"*"!==a&&"object"==typeof l[a][t]&&(i=o(l[a][t])))break}else l["*"]&&l["*"][t]&&(i=o(l["*"][t])),!i&&l[e]&&l[e][t]&&(i=o(l[e][t]));if(i)throw"A channel is already bound to the same window which overlaps with origin '"+e+"' and has scope '"+t+"'";"object"!=typeof l[e]&&(l[e]={}),"object"!=typeof l[e][t]&&(l[e][t]=[]),l[e][t].push({win:r,handler:n})}(w.window,w.origin,"string"==typeof w.scope?w.scope:"",c);var u=function(e){return"string"==typeof w.scope&&w.scope.length&&(e=[w.scope,e].join("::")),e},S=function(e,t){if(!e)throw"postMessage called with null message";if(v((n?"post  ":"queue ")+" message: "+JSON.stringify(e)),t||n){if("function"==typeof w.postMessageObserver)try{w.postMessageObserver(w.origin,e)}catch(e){v("postMessageObserver() raised an exception: "+e.toString())}w.window.postMessage(JSON.stringify(e),w.origin)}else o.push(e)},i={unbind:function(e){if(y[e]){if(!delete y[e])throw"can't delete method: "+e;return!0}return!1},bind:function(e,t){if(!e||"string"!=typeof e)throw"'method' argument to bind must be string";if(!t||"function"!=typeof t)throw"callback missing from bind params";if(y[e])throw"method '"+e+"' is already bound!";return y[e]=t,this},call:function(e){if(!e)throw"missing arguments to call function";if(!e.method||"string"!=typeof e.method)throw"'method' argument to call must be string";if(!e.success||"function"!=typeof e.success)throw"'success' callback missing from call";var o={},i=[],a=function(e,t){if("object"==typeof t)for(var r in t)if(t.hasOwnProperty(r)){var n=e+(e.length?"/":"")+r;"function"==typeof t[r]?(o[n]=t[r],i.push(n),delete t[r]):"object"==typeof t[r]&&a(n,t[r])}};a("",e.params);var t,r,n,s={id:d,method:u(e.method),params:e.params};i.length&&(s.callbacks=i),e.timeout&&(t=d,r=e.timeout,n=u(e.method),window.setTimeout(function(){if(b[t]){var e="timeout ("+r+"ms) exceeded on method '"+n+"'";(0,b[t].error)("timeout_error",e),delete b[t],delete q[t]}},r)),b[d]={callbacks:o,error:e.error,success:e.success},q[d]=c,d++,S(s)},notify:function(e){if(!e)throw"missing arguments to notify function";if(!e.method||"string"!=typeof e.method)throw"'method' argument to notify must be string";S({method:u(e.method),params:e.params})},destroy:function(){!function(e,t,r){for(var n=l[t][r],o=0;o<n.length;o++)n[o].win===e&&n.splice(o,1);0===l[t][r].length&&delete l[t][r]}(w.window,w.origin,"string"==typeof w.scope?w.scope:""),window.removeEventListener?window.removeEventListener("message",c,!1):window.detachEvent&&window.detachEvent("onmessage",c),n=!1,y={},E={},b={},w.origin=null,o=[],v("channel destroyed"),r=""}};return i.bind("__ready",function(e,t){if(v("ready msg received"),n)throw"received ready message while in ready state.  help!";for(r+="ping"===t?"-R":"-L",i.unbind("__ready"),n=!0,v("ready msg accepted."),"ping"===t&&i.notify({method:"__ready",params:"pong"});o.length;)S(o.pop());"function"==typeof w.onReady&&w.onReady(i)}),setTimeout(function(){S({method:u("__ready"),params:"ping"},!0)},0),i}}}();!function(e){"use strict";var t=e.prototype,a=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){var r,n,o,i;return/^\s*text\/html\s*(?:;|$)/i.test(t)?((o=(n=document.implementation.createHTMLDocument("")).documentElement).innerHTML=e,i=o.firstElementChild,1===o.childElementCount&&"html"===i.localName.toLowerCase()&&n.replaceChild(i,o),r=n):r=a.apply(this,arguments),r}}(DOMParser),"function"!=typeof document.contains&&(Document.prototype.contains=function(e){return e===this||e.parentNode===this||this.documentElement.contains(e)}),function(s){"use strict";try{if("https://example.com/a"===new window.URL("../a","https://example.com/").href)return}catch(e){}var c=/^(?:[a-z]+:)?\/\/|data:/i;function e(e,t){if(void 0!==t){if(!c.test(t))throw new TypeError("Failed to construct 'URL': Invalid base URL");n=t,e=(r=e)&&n?(i=(o=(new s).parseFromString("<!doctype><html><head></head></html>","text/html")).createElement("base"),a=o.createElement("link"),o.head.appendChild(i),o.head.appendChild(a),i.href=n,a.href=r,a.href):r}var r,n,o,i,a;if(!c.test(e))throw new TypeError("Failed to construct 'URL': Invalid URL");this.href=e}e.prototype.href="",window.URL&&window.URL.createObjectURL&&(e.createObjectURL=window.URL.createObjectURL),window.URL&&window.URL.revokeObjectURL&&(e.revokeObjectURL=window.URL.revokeObjectURL),window.URL=e}(DOMParser),function(u,d,h,c,l,s,f,p,_,g,m,r){"use strict";function t(e){if(this.name="scopeerror",void 0!==e&&"string"!=typeof e)throw new TypeError("You must pass a string.");this.message=e||"Scope Error"}function w(e,t,r){var n;try{n=e.apply(r,t)}catch(e){return(new h.Queue).push(function(){return h.reject(e)})}return n instanceof h.Queue?n:(new h.Queue).push(function(){return n})}function n(r){var n;return new h.Promise(function(e,t){(n=new XMLHttpRequest).open("GET",r),n.onreadystatechange=function(){try{0===n.readyState?t(n):4===n.readyState&&(n.status<200||300<=n.status||!/^text\/html[;]?/.test(n.getResponseHeader("Content-Type")||"")?t(n):e(n))}catch(e){t(e)}},n.setRequestHeader("Accept","text/html"),n.withCredentials=!0,n.send()},function(){void 0!==n&&n.readyState!==n.DONE&&n.abort()})}(t.prototype=new Error).constructor=t;var v,y,i,o,a,b,E,S,L,e,q,C,O={},M={},R={},A=[],j=0,x=new RegExp("^(?:[a-z]+:)?//|data:","i"),P=!1,k=[];function N(e){var t,r,n,o,i,a;if(P)return console.info("-- Error dropped, as page is unloaded"),void console.info(e);for(k.push(e),k.push(new Error("stopping renderJS")),r=u.getElementsByTagName("body")[0];r.firstChild;)r.removeChild(r.firstChild);for(n=u.createElement("section"),(o=u.createElement("h1")).textContent="Unhandled Error",n.appendChild(o),(o=u.createElement("p")).textContent="Please report this error to the support team",n.appendChild(o),(o=u.createElement("p")).textContent="Location: ",(i=u.createElement("a")).href=i.textContent=d.location.toString(),o.appendChild(i),n.appendChild(o),(o=u.createElement("p")).textContent="User-agent: "+g.userAgent,n.appendChild(o),(o=u.createElement("p")).textContent="Date: "+new Date(Date.now()).toISOString(),n.appendChild(o),r.appendChild(n),t=0;t<k.length;t+=1){if((a=k[t])instanceof m&&void 0!==(a={string:a.toString(),message:a.message,type:a.type,target:a.target}).target&&k.splice(t+1,0,a.target),a instanceof XMLHttpRequest&&(a={message:a.toString(),readyState:a.readyState,status:a.status,statusText:a.statusText,response:a.response,responseUrl:a.responseUrl,response_headers:a.getAllResponseHeaders()}),a.constructor===Array||a.constructor===String||a.constructor===Object)try{a=JSON.stringify(a)}catch(e){}n=u.createElement("section"),(o=u.createElement("h2")).textContent=a.message||a,n.appendChild(o),void 0!==a.fileName&&((o=u.createElement("p")).textContent="File: "+a.fileName+": "+a.lineNumber,n.appendChild(o)),void 0!==a.stack&&((o=u.createElement("pre")).textContent="Stack: "+a.stack,n.appendChild(o)),r.appendChild(n)}console.error(e.stack),console.error(e)}function T(e){if(this.name="resolved",void 0!==e&&"string"!=typeof e)throw new TypeError("You must pass a string.");this.message=e||"Default Message"}function J(){if(!(this instanceof J))return new J}function U(e){e.hasOwnProperty("__monitor")&&(e.__monitor.cancel(),delete e.__monitor,e.__job_list=[])}function D(e){e.__sub_gadget_dict={},e.__job_list=[],void 0!==e.__json_state&&(e.state=JSON.parse(e.__json_state))}function G(){var e,t,r,n,o,i=this.element.querySelectorAll("[data-gadget-url]"),a=[],s=this;function c(n){return function(e){var t=s.__acquired_method_dict||{},r="reportGadgetDeclarationError";if(t.hasOwnProperty(r))return t[r].apply(s,[arguments,n]);throw e}}for(o=0;o<i.length;o+=1)t=(e=i[o]).getAttribute("data-gadget-scope"),r=e.getAttribute("data-gadget-url"),n=e.getAttribute("data-gadget-sandbox"),null!==r&&a.push(s.declareGadget(r,{element:e,scope:t||void 0,sandbox:n||void 0}).push(void 0,c(t)));return h.all(a)}function F(e,t,r,n){var o=w(r,n,e);e.__job_dict.hasOwnProperty(t)&&e.__job_dict[t].cancel(),e.__job_dict[t]=o,e.__monitor.monitor((new h.Queue).push(function(){return o}).push(void 0,function(e){if(!(e instanceof h.CancellationError))throw e}))}function Q(n){var t;(0!==n.constructor.__service_list.length||n.constructor.__job_declared)&&((t=n).__monitor=new y,t.__job_dict={},t.__job_triggered=!1,t.__monitor.fail(function(e){if(!(e instanceof h.CancellationError))return t.aq_reportServiceError(e)}).fail(N),n.__monitor.monitor((new h.Queue).push(function(){var e,t=n.constructor.__service_list,r=n.__job_list;for(e=0;e<t.length;e+=1)n.__monitor.monitor(t[e].apply(n));for(e=0;e<r.length;e+=1)F(n,r[e][0],r[e][1],r[e][2]);n.__job_list=[],n.__job_triggered=!0})))}function H(e,t,r){e.hasOwnProperty("__method_type_dict")||(e.__method_type_dict={}),e.__method_type_dict[t]=r}function I(r,n){r.__aq_parent=function(e,t){return function(e,t,r){var n,o,i=this,a=i.__acquired_method_dict||{};if(!a.hasOwnProperty(t))return i.__aq_parent(t,r);for(n in i.__sub_gadget_dict)i.__sub_gadget_dict.hasOwnProperty(n)&&i.__sub_gadget_dict[n]===e&&(o=n);return w(a[t],[r,o],i).push(void 0,function(e){if(e instanceof v.AcquisitionError)return i.__aq_parent(t,r);throw e})}.apply(n,[r,e,t])}}function K(){if(!(this instanceof K))return new K;J.call(this)}function z(e,t,r){void 0===t.element&&(t.element=u.createElement("div"));var n,o,i=e.__template_element.body.childNodes,a=u.createDocumentFragment();for((o=new e).element=t.element,o.state={},n=0;n<i.length;n+=1)a.appendChild(i[n].cloneNode(!0));return o.element.appendChild(a),I(o,r),o}function B(e,t,r){var n=v.declareGadgetKlass(e);return"function"==typeof n.then?n.then(function(e){return z(e,t,r)}):z(n,t,r)}function Y(){if(!(this instanceof Y))return new Y;J.call(this)}function X(e,t,r){var o,n,i=h.defer();if(void 0===t.element)throw new Error("DOM element is required to create Iframe Gadget "+e);if(!u.contains(t.element))throw new Error("The parent element is not attached to the DOM for "+e);return I(o=new Y,r),(n=u.createElement("iframe")).addEventListener("error",function(e){i.reject(e)}),n.addEventListener("load",function(){return h.timeout(5e3).fail(function(){i.reject(new Error("Timeout while loading: "+e))})}),n.setAttribute("src",e),o.__path=e,o.element=t.element,o.state={},t.element.appendChild(n),o.__chan=l.build({window:n.contentWindow,origin:"*",scope:"renderJS"}),o.__chan.bind("declareMethod",function(e,n){return o[n]=function(){var r=arguments,e=new h.Promise(function(e,t){o.__chan.call({method:"methodCall",params:[n,Array.prototype.slice.call(r,0)],success:e,error:t})});return w(function(){return e})},"OK"}),o.__chan.bind("ready",function(e){return i.resolve(o),"OK"}),o.__chan.bind("failed",function(e,t){return i.reject(t),"OK"}),o.__chan.bind("acquire",function(t,e){(new h.Queue).push(function(){return o.__aq_parent.apply(o,e)}).then(t.complete).fail(function(e){t.error(e.toString())}),t.delayReturn(!0)}),i.promise}function V(a,t,r){return(new h.Queue).push(function(){return n(a)}).push(function(e){var t,r,n,o=(new c).parseFromString(e.responseText,"text/html"),i=o.createElement("base");return i.href=a,o.head.insertBefore(i,o.head.firstChild),t=new _([o.documentElement.outerHTML],{type:"text/html;charset=UTF-8"}),r=t,n=new p,new h.Promise(function(t,e){n.addEventListener("load",function(e){t(e.target.result)}),n.addEventListener("error",e),n.readAsDataURL(r)},function(){n.abort()})}).push(function(e){return X(e,t,r)})}function W(t,e,r,n){var o,i,a;if(D(t),void 0===(i=e.scope))for(i="RJS_"+j,j+=1;r.__sub_gadget_dict.hasOwnProperty(i);)i="RJS_"+j,j+=1;function s(e){return function(){return e.call(t,t)}}function c(){return u.contains(t.element)&&Q(t),t}if((r.__sub_gadget_dict[i]=t).element.setAttribute("data-gadget-scope",i),t.element.setAttribute("data-gadget-url",n),t.element.setAttribute("data-gadget-sandbox",e.sandbox),(t.element._gadget=t).constructor.__ready_list.length){for(a=new h.Queue,o=0;o<t.constructor.__ready_list.length;o+=1)a.push(s(t.constructor.__ready_list[o]));return a.push(c),a}return c()}function Z(e){var t,r,n,o,i,a,s,c,u;if(O.hasOwnProperty(e))throw new Error("bootstrap should not be called twice");return(t=K).__ready_list=[],t.__service_list=J.__service_list.slice(),t.prototype.__path=e,I(r=new t,((u=new J).__acquired_method_dict={reportServiceError:function(e){N(e[0])}},u.__aq_parent=function(e){throw new v.AcquisitionError("No gadget provides "+e)},u)),o=function(e){i.push(e)},c=[t,r,n,i=["getInterfaceList","getRequiredCSSList","getRequiredJSList","getPath","getTitle","getMethodList"]],d.self===d.top?a=c:(s=h.defer(),a=h.any([s.promise,(new h.Queue).push(function(){return h.delay(1e3)}).push(function(){return c[2]=void 0,c})]),n=l.build({window:d.parent,origin:"*",scope:"renderJS",onReady:function(){var e,t;for(o=function(r){i.push(new h.Promise(function(e,t){n.call({method:"declareMethod",params:r,success:e,error:t})}))},t=i.length,e=0;e<t;e+=1)o(i[e]);s.resolve(c)}}),c[2]=n),t.declareMethod=function(e,t){var r=J.declareMethod.apply(this,[e,t]);return o(e),r},t.declareService=J.declareService,t.declareJob=J.declareJob,t.onEvent=J.onEvent,t.onLoop=J.onLoop,t.declareAcquiredMethod=J.declareAcquiredMethod,t.allowPublicAcquisition=J.allowPublicAcquisition,t.prototype.__acquired_method_dict={},A.push(t),a}d.addEventListener("error",function(e){k.push(e)}),d.addEventListener("beforeunload",function(){P=!0}),(i=function(){if(!(this instanceof i))return new i;this._latest_promise=null}).prototype={constructor:i,lockAndRun:function(e){var t=this._latest_promise;return this._latest_promise=null===t?h.resolve(e()):this._latest_promise.always(function(){return e()}),this._latest_promise}},(T.prototype=new Error).constructor=T,(y=function(){var e,r,n,o=this,i=[];if(!(this instanceof y))return new y;function a(){var e,t=i.length;for(e=0;e<t;e+=1)i[e].cancel();i=[]}e=new h.Promise(function(e,t){r=function(e){if(!n)return o.isRejected=!0,o.rejectedReason=e,n=!0,a(),t(e)}},a),o.cancel=function(){n||(n=!0,e.cancel(),e.fail(function(e){o.isRejected=!0,o.rejectedReason=e}))},o.then=e.then.bind(e),o.fail=e.fail.bind(e),o.monitor=function(t){if(n)throw new T;var e=(new h.Queue).push(function(){return t}).push(function(e){var t,r,n=i.length,o=[];for(r=0;r<n;r+=1)(t=i[r]).isFulfilled||t.isRejected||o.push(t);i=o},function(e){throw e instanceof h.CancellationError&&(t.isFulfilled&&t.isRejected||t.cancel()),r(e),e});return i.push(e),this}}).prototype=Object.create(h.Promise.prototype),y.prototype.constructor=y,J.prototype.__title="",J.prototype.__interface_list=[],J.prototype.__path="",J.prototype.__html="",J.prototype.__required_css_list=[],J.prototype.__required_js_list=[],J.__ready_list=[],J.ready=function(e){return this.__ready_list.push(e),this},J.setState=function(e){return this.prototype.__json_state=JSON.stringify(e),this},J.onStateChange=function(e){return this.prototype.__state_change_callback=e,this},J.__service_list=[],J.declareService=function(e){return this.__service_list.push(e),this},J.onEvent=function(e,t,r,n){return this.__service_list.push(function(){return function(n,o,i,a,s){var c,u;function d(){void 0!==u&&"function"==typeof u.cancel&&u.cancel()}function l(){void 0!==c&&n.removeEventListener(o,c,i),d()}return void 0===s&&(s=!0),new h.Promise(function(e,t){var r;c=function(e){s&&(e.stopPropagation(),e.preventDefault()),d();try{r=a(e)}catch(e){r=h.reject(e)}u=r,(new h.Queue).push(function(){return r}).push(void 0,function(e){e instanceof h.CancellationError||(l(),t(e))})},n.addEventListener(o,c,i)},l)}(this.element,e,r,t.bind(this),n)}),this},J.onLoop=function(n,o){return void 0===o&&(o=0),this.__service_list.push(function(){var e=new h.Queue,t=this,r=function(){e.push(function(){return h.delay(o)}).push(function(){return new h.Promise(function(e){t=d.requestAnimationFrame(e)},function(){d.cancelAnimationFrame(t)});var t}).push(function(){return n.apply(t,[])}).push(r)};return r(),e}),this},J.declareJob=function(t,r){return this.__job_declared=!0,this.prototype[t]=function(){var e=arguments;this.__job_triggered?F(this,t,r,e):this.__job_list.push([t,r,e])},H(this,t,"job"),this},J.declareMethod=function(e,n,o){return this.prototype[e]=function(){var e,t=this,r=arguments;return void 0!==o&&o.hasOwnProperty("mutex")?(e="__mutex_"+o.mutex,t.hasOwnProperty(e)||(t[e]=new i),w(t[e].lockAndRun,[function(){return n.apply(t,r)}],t[e])):w(n,r,t)},H(this,e,"method"),this},J.declareMethod("getInterfaceList",function(){return this.__interface_list}).declareMethod("getMethodList",function(e){var t,r=[],n=this.constructor.__method_type_dict||{};for(t in n)n.hasOwnProperty(t)&&(void 0!==e&&e!==n[t]||r.push(t));return r}).declareMethod("getRequiredCSSList",function(){return this.__required_css_list}).declareMethod("getRequiredJSList",function(){return this.__required_js_list}).declareMethod("getPath",function(){return this.__path}).declareMethod("getTitle",function(){return this.__title}).declareMethod("getElement",function(){if(void 0===this.element)throw new Error("No element defined");return this.element}).declareMethod("changeState",function(e){var t,r,n=this,o=!1,i=n.hasOwnProperty("__modification_dict");for(t in i?(r=n.__modification_dict,o=!0):r={},e)e.hasOwnProperty(t)&&e[t]!==n.state[t]&&(n.state[t]=e[t],r[t]=e[t],o=!0);if(o&&void 0!==n.__state_change_callback)return n.__modification_dict=r,w(n.__state_change_callback,[r],n).push(function(e){return delete n.__modification_dict,e})},{mutex:"changestate"}),J.declareAcquiredMethod=function(e,t){return this.prototype[e]=function(){var e=Array.prototype.slice.call(arguments,0);return w(this.__aq_parent,[t,e],this)},H(this,e,"acquired_method"),this},J.declareAcquiredMethod("aq_reportServiceError","reportServiceError"),J.declareAcquiredMethod("aq_reportGadgetDeclarationError","reportGadgetDeclarationError"),J.allowPublicAcquisition=function(e,t){return this.prototype.__acquired_method_dict[e]=t,this},K.__ready_list=[],K.__service_list=J.__service_list.slice(),K.ready=J.ready,K.setState=J.setState,K.onStateChange=J.onStateChange,K.declareService=J.declareService,K.onEvent=J.onEvent,K.onLoop=J.onLoop,(K.prototype=new J).constructor=K,Y.__ready_list=[],Y.ready=J.ready,Y.setState=J.setState,Y.onStateChange=J.onStateChange,Y.__service_list=[],Y.declareService=J.declareService,Y.onEvent=J.onEvent,Y.onLoop=J.onLoop,(Y.prototype=new J).constructor=Y,J.declareMethod("declareGadget",function(t,r){var e,n,o=this;if(void 0===r&&(r={}),void 0===r.sandbox&&(r.sandbox="public"),t=v.getAbsoluteURL(t,this.__path),"public"===r.sandbox)e=B;else if("iframe"===r.sandbox)e=X;else{if("dataurl"!==r.sandbox)throw new Error("Unsupported sandbox options '"+r.sandbox+"'");e=V}return"function"==typeof(n=e(t,r,o)).then?(new h.Queue).push(function(){return n}).push(function(e){return W(e,r,o,t)}):W(n,r,o,t)}).declareMethod("getDeclaredGadget",function(e){if(!this.__sub_gadget_dict.hasOwnProperty(e))throw new t("Gadget scope '"+e+"' is not known.");return this.__sub_gadget_dict[e]}).declareMethod("dropGadget",function(e){if(!this.__sub_gadget_dict.hasOwnProperty(e))throw new t("Gadget scope '"+e+"' is not known.");delete this.__sub_gadget_dict[e]}),(v=function(e){var t;if(e===d&&(t=A[0]),void 0===t)throw new Error("Unknown selector '"+e+"'");return t}).AcquisitionError=function(e){if(this.name="AcquisitionError",void 0!==e&&"string"!=typeof e)throw new TypeError("You must pass a string.");this.message=e||"Acquisition failed"},v.AcquisitionError.prototype=new Error,v.AcquisitionError.prototype.constructor=v.AcquisitionError,v.getAbsoluteURL=function(e,t){return t&&e?new r(e,t).href:e},v.declareJS=function(n,o,i){var e;return M.hasOwnProperty(n)?e=h.resolve():(M[n]=null,e=new h.Promise(function(e,t){var r;(r=u.createElement("script")).async=!1,r.type="text/javascript",r.onload=function(){!0===i&&A.shift(),e()},r.onerror=function(e){!0===i&&A.shift(),t(e)},r.src=n,o.appendChild(r)})),e},v.declareCSS=function(n,o){return R.hasOwnProperty(n)?h.resolve():new h.Promise(function(e,t){var r;(r=u.createElement("link")).rel="stylesheet",r.type="text/css",r.href=n,r.onload=function(){R[n]=null,e()},r.onerror=t,o.appendChild(r)})},v.declareGadgetKlass=function(a){var s,e;if(O.hasOwnProperty(a)){if(O[a].hasOwnProperty("defer_list"))return e=h.defer(),O[a].defer_list.push(e),e.promise;if(O[a].is_resolved)return O[a].result;throw O[a].result}return O[a]={defer_list:[]},(new h.Queue).push(function(){return n(a)}).push(function(e){s=function(e,t){var r,n,o;for(n in(r=function(){J.call(this)}).__ready_list=[],r.__service_list=J.__service_list.slice(),r.declareMethod=J.declareMethod,r.declareJob=J.declareJob,r.declareAcquiredMethod=J.declareAcquiredMethod,r.allowPublicAcquisition=J.allowPublicAcquisition,r.ready=J.ready,r.setState=J.setState,r.onStateChange=J.onStateChange,r.declareService=J.declareService,r.onEvent=J.onEvent,r.onLoop=J.onLoop,((r.prototype=new J).constructor=r).prototype.__path=t,r.prototype.__acquired_method_dict={},r.__template_element=(new c).parseFromString(e.responseText,"text/html"),o=v.parseGadgetHTMLDocument(r.__template_element,t))o.hasOwnProperty(n)&&(r.prototype["__"+n]=o[n]);return r.__template_element.querySelectorAll("[data-gadget-url]").length&&r.__ready_list.push(G),r}(e,a);var t,r=u.createDocumentFragment(),n=[],o=s.prototype.__required_js_list,i=s.prototype.__required_css_list;if(o.length){for(A.push(s),t=0;t<o.length-1;t+=1)n.push(v.declareJS(o[t],r));n.push(v.declareJS(o[t],r,!0))}for(t=0;t<i.length;t+=1)n.push(v.declareCSS(i[t],r));return u.head.appendChild(r),h.all(n)}).push(function(){var e,t=O[a].defer_list.length;for(e=0;e<t;e+=1)O[a].defer_list[e].resolve(s);return delete O[a].defer_list,O[a].result=s,O[a].is_resolved=!0,s}).push(void 0,function(e){var t,r=O[a].defer_list.length;for(t=0;t<r;t+=1)O[a].defer_list[t].reject(e);throw delete O[a].defer_list,O[a].result=e,O[a].is_resolved=!1,e})},v.clearGadgetKlassList=function(){O={},M={},R={}},v.parseGadgetHTMLDocument=function(e,t){var r,n,o={title:"",interface_list:[],required_css_list:[],required_js_list:[]};if(!t||!x.test(t))throw new Error("The url should be absolute: "+t);if(9!==e.nodeType)throw new Error("The first parameter should be an HTMLDocument");if(o.title=e.title,null!==e.head)for(r=0;r<e.head.children.length;r+=1)null!==(n=e.head.children[r]).href&&("stylesheet"===n.rel?o.required_css_list.push(v.getAbsoluteURL(n.getAttribute("href"),t)):"SCRIPT"!==n.nodeName||"text/javascript"!==n.type&&n.type?"http://www.renderjs.org/rel/interface"===n.rel&&o.interface_list.push(v.getAbsoluteURL(n.getAttribute("href"),t)):o.required_js_list.push(v.getAbsoluteURL(n.getAttribute("src"),t)));return o},v.Mutex=i,v.ScopeError=t,d.rJS=d.renderJS=v,d.__RenderJSGadget=J,d.__RenderJSEmbeddedGadget=K,d.__RenderJSIframeGadget=Y,o=new h.defer,v.manualBootstrap=function(){o.resolve()},u.addEventListener("DOMContentLoaded",o.resolve,!1),q=d.location.href,0<(C=q.indexOf("#"))&&(q=q.substring(0,C)),e=Z(a=q),(new h.Queue).push(function(){return e}).push(function(e){return b=e[0],E=e[1],S=e[2],L=e[3],o.promise}).push(function(){return h.all(L)}).push(function(e){var t,r,i;return void 0!==S&&(t=b,i=S,(r=E).__aq_parent=t.prototype.__aq_parent=function(r,n,o){return new h.Promise(function(e,t){i.call({method:"acquire",params:[r,n],success:e,error:t,timeout:o})})},i.bind("methodCall",function(t,e){r[e[0]].apply(r,e[1]).push(t.complete,function(e){t.error(e.toString())}),t.delayReturn(!0)})),function(e,t,r){var n,o,i=v.parseGadgetHTMLDocument(u,t),a=u.createDocumentFragment();for(o in i)i.hasOwnProperty(o)&&(e.prototype["__"+o]=i[o]);for(e.__template_element=u.createElement("div"),r.element=u.body,r.state={},n=0;n<r.element.childNodes.length;n+=1)a.appendChild(r.element.childNodes[n].cloneNode(!0));return e.__template_element.appendChild(a),h.all([r.getRequiredJSList(),r.getRequiredCSSList()]).then(function(e){var t,r=e[0],n=e[1];for(t=0;t<r.length;t+=1)M[r[t]]=null;for(t=0;t<n.length;t+=1)R[n[t]]=null;A.shift()}).then(function(){var e=u.querySelector("body");return new s(function(e){var t,r,n,o,i,a;e.forEach(function(e){if("childList"===e.type){for(n=e.removedNodes.length,t=0;t<n;t+=1)if((i=e.removedNodes[t]).nodeType===f.ELEMENT_NODE)for(i.hasAttribute("data-gadget-url")&&void 0!==i._gadget&&U(i._gadget),a=i.querySelectorAll("[data-gadget-url]"),o=a.length,r=0;r<o;r+=1)void 0!==(i=a[r])._gadget&&U(i._gadget);for(n=e.addedNodes.length,t=0;t<n;t+=1)if((i=e.addedNodes[t]).nodeType===f.ELEMENT_NODE)for(i.hasAttribute("data-gadget-url")&&void 0!==i._gadget&&u.contains(i)&&Q(i._gadget),a=i.querySelectorAll("[data-gadget-url]"),o=a.length,r=0;r<o;r+=1)i=a[r],u.contains(i)&&void 0!==i._gadget&&Q(i._gadget)}})}).observe(e,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),r})}(b,a,E)}).push(function(){return D(E),b.__ready_list.unshift(G),function(e,t){var r,n=new h.Queue;function o(e){return function(){return e.call(t,t)}}for(e.ready(function(){return Q(t)}),r=0;r<e.__ready_list.length;r+=1)n.push(o(e.__ready_list[r]));return n}(b,E)}).push(function(){void 0!==S&&S.notify({method:"ready"})}).push(void 0,function(e){throw N(e),void 0!==S&&S.notify({method:"failed",params:e.toString()}),e})}(document,window,RSVP,DOMParser,Channel,MutationObserver,Node,FileReader,Blob,navigator,Event,URL);